name: CI-CD

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs: 
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name : Install Dependencies
        run: npm install

      - name: Prisma generate
        run: npx prisma generate
        env:
          DATABASE_URL: "mysql://user:pass@localhost:3306/db"
      
      - name: Build Nuxt
        run: npm run build

      # - name: Debug - list build outputs
      #   run: |
      #     ls -la
      #     ls -la .output || true
      #     ls -la prisma || true
      #     ls -la generated || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy_bundle
          path: |
            .output/
            prisma/
            prisma.config.ts
            package.json
            package-lock.json
            generated/
          include-hidden-files: true
          retention-days: 1
  
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy_bundle
          path: deploy_bundle
          merge-multiple: true

      - name: Setup SSH
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Package + upload bundle
        shell: bash
        run: |
          set -e
          # ls -la deploy_bundle
          tar -czf deploy_bundle.tgz -C deploy_bundle .
          scp -i ~/.ssh/id_rsa deploy_bundle.tgz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_APP_PATH }}/incoming.tgz

      - name: Switch + migrate + restart
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<'SSH'
          set -euo pipefail

          APP_PATH="${{ secrets.VPS_APP_PATH }}"
          cd "$APP_PATH"

          mkdir -p deploy backups incoming

          TS="$(date +%Y%m%d_%H%M%S)"
          BACKUP_DIR="backups/$TS"

          echo "==> Backup current deploy (if exists)"
          mkdir -p "$BACKUP_DIR"
          if [ -d "deploy/.output" ]; then
            cp -a deploy/.output "$BACKUP_DIR/.output"
          fi
          if [ -d "prisma" ]; then
            cp -a prisma "$BACKUP_DIR/prisma"
          fi
          if [ -d "generated" ]; then
            cp -a "generated" "$BACKUP_DIR/generated"
          fi
          if [ -f "prisma.config.ts" ]; then
            cp -a "prisma.config.ts" "$BACKUP_DIR/prisma.config.ts"
          fi
          if [ -f "package.json" ]; then
            cp -a "package.json" "$BACKUP_DIR/package.json"
          fi
          if [ -f "package-lock.json" ]; then
            cp -a "package-lock.json" "$BACKUP_DIR/package-lock.json"
          fi

          echo "==> Extract bundle"
          rm -rf incoming
          mkdir -p incoming
          tar -xzf incoming.tgz -C incoming
          rm -f incoming.tgz

          echo "==> Switch incoming -> deploy"
          # incoming contient .output/, prisma/, et generated/
          rm -rf deploy/.output
          mkdir -p deploy
          mv incoming/.output deploy/.output
          rm -rf prisma
          mv incoming/prisma prisma
          rm -rf generated
          mv incoming/generated generated
          rm -f prisma.config.ts
          mv incoming/prisma.config.ts prisma.config.ts
          rm -f package.json
          mv incoming/package.json package.json
          rm -f package-lock.json
          mv incoming/package-lock.json package-lock.json
          rmdir incoming || true

          echo "==> Run migrations (docker compose run --rm migrate)"
          ls -la
          cd "../.."
          docker compose run --rm migrate

          echo "==> Restart app"
          docker compose up -d --build petcare

          echo "==> Done"
          SSH
